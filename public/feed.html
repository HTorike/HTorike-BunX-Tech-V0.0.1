<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BunX-Tech | Feed</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Space+Grotesk:wght@700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bun-pink: #ff43ad;
        }

        body {
            background-color: #000;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top center, #111 0%, #000 80%);
            color: #fff;
            min-height: 100vh;
        }

        .bun-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bun-card:hover {
            border-color: rgba(255, 67, 173, 0.4);
            box-shadow: 0 0 25px rgba(255, 67, 173, 0.1);
            transform: translateY(-2px);
        }

        .font-tech {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* --- Skeleton Loading --- */
        @keyframes shimmer {
            0% {
                background-position: -600px 0;
            }

            100% {
                background-position: 600px 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.04) 25%, rgba(255, 255, 255, 0.09) 50%, rgba(255, 255, 255, 0.04) 75%);
            background-size: 600px 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 6px;
        }
    </style>
</head>

<body class="p-4 md:p-10 flex justify-center">

    <script>
        if (!localStorage.getItem('usuario')) {
            window.location.href = '/login-page';
        }
    </script>

    <div class="w-full max-w-6xl flex flex-col md:flex-row gap-10">

        <main class="flex-1 max-w-2xl">
            <div class="mb-10 border-l-2 border-pink-500 pl-6">
                <h1 class="text-4xl font-tech font-bold italic tracking-tighter neon-glow">
                    bun<span class="text-pink-500">x</span>
                </h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-[0.5em] mt-2">Sincroniza√ß√£o Ativa</p>
            </div>

            <section class="bun-card p-6 rounded-xl mb-10 border-l-4 border-pink-500">
                <textarea id="post-conteudo"
                    class="w-full bg-transparent outline-none text-white placeholder-gray-600 resize-none h-20"
                    placeholder="O que est√° acontecendo na rede" oninput="atualizarContador(this.value)"
                    maxlength="280"></textarea>
                <div class="flex justify-end mt-1">
                    <span id="char-counter"
                        class="text-[10px] text-gray-600 font-tech tabular-nums transition-colors">0/280</span>
                </div>

                <!-- Campo de imagem colaps√°vel -->
                <div id="imagem-container" class="hidden mt-3">
                    <div
                        class="flex items-center gap-2 bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus-within:border-pink-500/60 transition-colors">
                        <span class="text-gray-500 text-sm">üîó</span>
                        <input id="post-imagem-url" type="url" placeholder="Cole a URL da imagem aqui..."
                            class="flex-1 bg-transparent outline-none text-white text-xs placeholder-gray-600"
                            oninput="previewImagem(this.value)" />
                        <button onclick="limparImagem()"
                            class="text-gray-600 hover:text-red-400 transition-colors text-xs" title="Remover imagem">
                            ‚úï
                        </button>
                    </div>
                    <!-- Preview em tempo real -->
                    <div id="imagem-preview-wrapper" class="hidden mt-2 pl-1">
                        <img id="imagem-preview" src="" alt="Preview"
                            class="rounded-lg border border-white/10 max-h-40 w-auto object-cover opacity-70 hover:opacity-100 transition-opacity"
                            onerror="this.parentElement.classList.add('hidden')" />
                    </div>
                </div>

                <div class="flex justify-between items-center mt-4 border-t border-white/5 pt-4">
                    <div class="flex items-center gap-4">
                        <span class="text-[9px] text-gray-500 uppercase tracking-widest">Criptografia: Ativa</span>
                        <button onclick="toggleImagem()" id="btn-imagem" title="Anexar imagem"
                            class="text-gray-500 hover:text-pink-400 transition-colors text-base leading-none">
                            üñºÔ∏è
                        </button>
                    </div>
                    <button onclick="enviarPost()"
                        class="bg-white text-black px-6 py-2 rounded-lg font-bold text-xs uppercase tracking-tighter hover:bg-pink-500 hover:text-white transition-all">
                        Transmitir
                    </button>
                </div>
            </section>

            <div id="feed-container" class="space-y-6">
            </div>
        </main>

        <aside class="w-full md:w-80 space-y-4">
            <div class="sticky top-10">
                <h2
                    class="text-[10px] text-gray-600 uppercase tracking-widest mb-6 font-bold border-b border-white/5 pb-2">
                    M√≥dulos do Sistema
                </h2>

                <button
                    class="w-full bun-card p-4 rounded-lg flex items-center justify-between group opacity-60 cursor-not-allowed">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üë•</span>
                        <span class="font-tech text-xs uppercase tracking-tighter">Conex√µes</span>
                    </div>
                    <span class="text-[9px] bg-white/10 px-2 py-1 rounded text-gray-400">OFFLINE</span>
                </button>

                <button
                    class="w-full bun-card p-4 rounded-lg flex items-center justify-between group mt-3 opacity-60 cursor-not-allowed">
                    <div class="flex items-center gap-3">
                        <span class="text-xl text-purple-500">üéß</span>
                        <span class="font-tech text-xs uppercase tracking-tighter">Canais ativos</span>
                    </div>
                    <span
                        class="text-[9px] border border-purple-500/50 text-purple-400 px-2 py-1 rounded">ENCRIPTADO</span>
                </button>

                <button
                    class="w-full bun-card p-4 rounded-lg flex items-center justify-between group mt-3 opacity-60 cursor-not-allowed">
                    <div class="flex items-center gap-3">
                        <span class="text-xl text-pink-500">üí¨</span>
                        <span class="font-tech text-xs uppercase tracking-tighter">Mensagens</span>
                    </div>
                    <span class="text-[9px] text-pink-500 animate-pulse">LOCK</span>
                </button>

                <div class="mt-20 p-6 border-t border-white/10 text-center">
                    <img id="sidebar-avatar" src="https://api.dicebear.com/9.x/bottts/svg?seed=guest"
                        class="w-16 h-16 rounded-full mx-auto mb-4 border-2 border-pink-500/30 bg-pink-500/10" />
                    <p id="user-display" class="font-tech italic text-sm">Usu√°rio n√£o identificado</p>
                    <button onclick="localStorage.clear(); window.location.href='/login-page'"
                        class="text-[9px] text-red-500 mt-4 uppercase tracking-widest hover:underline">Desconectar</button>
                </div>
            </div>
        </aside>

    </div>

    <script>

        (function verificarAcesso() {
            const usuarioLogado = localStorage.getItem('usuario');
            if (!usuarioLogado) {
                window.location.href = '/login-page';
            }
        })

        function toggleImagem() {
            const container = document.getElementById('imagem-container');
            const btn = document.getElementById('btn-imagem');
            const isHidden = container.classList.contains('hidden');
            container.classList.toggle('hidden', !isHidden);
            btn.style.color = isHidden ? 'rgb(236, 72, 153)' : '';
            if (!isHidden) limparImagem();
        }

        function previewImagem(url) {
            const wrapper = document.getElementById('imagem-preview-wrapper');
            const img = document.getElementById('imagem-preview');
            const isImageUrl = /https?:\/\/\S+\.(?:png|jpg|jpeg|gif|svg|webp)/i.test(url);
            if (isImageUrl) {
                img.src = url;
                wrapper.classList.remove('hidden');
            } else {
                wrapper.classList.add('hidden');
            }
        }

        function limparImagem() {
            document.getElementById('post-imagem-url').value = '';
            document.getElementById('imagem-preview-wrapper').classList.add('hidden');
            document.getElementById('imagem-preview').src = '';
        }

        async function enviarPost() {
            const textoBase = document.getElementById('post-conteudo').value.trim();
            const urlImagem = document.getElementById('post-imagem-url').value.trim();
            const token = localStorage.getItem('token');

            // Concatena URL da imagem ao texto se existir
            const conteudo = urlImagem ? `${textoBase} ${urlImagem}`.trim() : textoBase;

            if (!conteudo) return;

            const response = await fetch('/postar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({ conteudo })
            });

            if (response.ok) {
                document.getElementById('post-conteudo').value = '';
                limparImagem();
                // Fecha o painel de imagem ap√≥s transmitir
                const container = document.getElementById('imagem-container');
                if (!container.classList.contains('hidden')) toggleImagem();
                carregarFeed();
            }
        }

        //0.1 Fun√ß√£o para processamento do conte√∫do (ex: links)
        function processarConteudo(texto) {
            const regexImagem = /(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|svg|webp))/i;
            const match = texto.match(regexImagem);

            if (match) {
                const urlImagem = match[0];
                const textoSemUrl = texto.replace(urlImagem, '').trim();
                return `
                <p class="text-gray-300 leading-relaxed pl-14 mb-4">${textoSemUrl}</p>
                <div class="pl-14">
                    <img src="${urlImagem}" class="rounded-lg border border-white/10 max-h-80 w-auto hover:scale-[1.02] transition-transform" onerror="this.style.display='none'">
                </div>
                `;
            }

            return `<p class="text-gray-300 leading-relaxed pl-14">${texto}</p>`;

        }

        // 1. Fun√ß√£o para criar o design do Card
        function criarCardHTML(post) {
            const userLogado = JSON.parse(localStorage.getItem('usuario'));
            const botaodeletar = userLogado && post.usuario_id === userLogado.id
                ? `<button onclick="deletarPost(${post.id})" class="text-gray-600 hover:text-red-500 transition-colors text-[9px] uppercase tracking-tighter">
                    [ APAGAR_SINAL ]
                </button>`
                : '';

            return `
                <article class="bun-card p-6 rounded-xl mb-4 border-l-2 border-transparent hover:border-pink-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed=${encodeURIComponent(post.username)}" alt="${post.username}" class="w-10 h-10 rounded-full bg-pink-500/10 border border-pink-500/20" />
                            <div>
                                <h3 class="font-bold text-pink-500 tracking-wide">${post.username}</h3>
                                <span class="text-[9px] text-gray-600 uppercase">BunX ID: #${post.usuario_id}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-[10px] text-gray-500 font-tech uppercase italic">${post.tempo_relativo}</span>
                            ${botaodeletar}
                        </div>
                    </div>
                    ${processarConteudo(post.conteudo)}
                </article>
            `;
        }

        async function deletarPost(id) {
            if (!confirm("Confirmar exclus√£o permanente deste sinal?")) return;

            const user = JSON.parse(localStorage.getItem('usuario'));

            try {
                const response = await fetch(`/postar/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'user-id': user.id // Enviando para o Middleware validar
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    carregarFeed(); // Recarrega a lista
                } else {
                    alert(data.mensagem);
                }
            } catch (e) {
                alert("Erro ao tentar comunicar com o n√∫cleo.");
            }
        }

        // Melhoria 2: Contador de caracteres
        function atualizarContador(valor) {
            const count = valor.length;
            const counter = document.getElementById('char-counter');
            counter.textContent = `${count}/280`;
            if (count >= 270) {
                counter.style.color = '#ef4444'; // vermelho
            } else if (count >= 240) {
                counter.style.color = '#eab308'; // amarelo
            } else {
                counter.style.color = '';
            }
        }

        // Melhoria 3: Skeleton Loading
        function mostrarSkeleton() {
            const skeletonCard = `
                <article class="bun-card p-6 rounded-xl mb-4 border-l-2 border-transparent">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="skeleton w-10 h-10 rounded-full flex-shrink-0"></div>
                        <div class="flex-1 space-y-2">
                            <div class="skeleton h-3 w-24 rounded"></div>
                            <div class="skeleton h-2 w-16 rounded"></div>
                        </div>
                    </div>
                    <div class="pl-14 space-y-2">
                        <div class="skeleton h-3 w-full rounded"></div>
                        <div class="skeleton h-3 w-3/4 rounded"></div>
                    </div>
                </article>`;
            document.getElementById('feed-container').innerHTML =
                skeletonCard + skeletonCard + skeletonCard;
        }

        // 3. Fun√ß√£o para buscar dados da API e colocar na tela
        async function carregarFeed() {
            const container = document.getElementById('feed-container');
            mostrarSkeleton();
            try {
                const response = await fetch('/feed', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    }
                });
                const posts = await response.json();

                container.innerHTML = posts.length > 0
                    ? posts.map(post => criarCardHTML(post)).join('')
                    : '<p class="text-center text-gray-600 py-10 uppercase text-xs tracking-[0.5em]">Nenhum sinal detectado na rede...</p>';
            } catch (e) {
                container.innerHTML = '<p class="text-red-500 text-center">Erro na sincroniza√ß√£o.</p>';
            }
        }

        // 4. Identifica√ß√£o do Usu√°rio na Sidebar (com avatar DiceBear)
        const user = JSON.parse(localStorage.getItem('usuario'));
        if (user) {
            document.getElementById('user-display').innerText = user.username;
            document.getElementById('sidebar-avatar').src =
                `https://api.dicebear.com/9.x/bottts/svg?seed=${encodeURIComponent(user.username)}`;
        }

        // Inicializa o feed ao abrir a p√°gina
        carregarFeed();
    </script>
</body>

</html>